---
name: Cleanup Merged Branches

on:
  workflow_dispatch:
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete merged branches
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching all branches..."
          git fetch --all --prune

          # Get the default branch (main)
          DEFAULT_BRANCH=$(git remote show origin | \
            grep 'HEAD branch' | cut -d' ' -f5)
          echo "Default branch: $DEFAULT_BRANCH"

          # List all merged branches except main and the current branch
          echo "Finding branches merged into $DEFAULT_BRANCH..."
          MERGED_BRANCHES=$(git branch -r \
            --merged origin/$DEFAULT_BRANCH | \
            grep -v "HEAD" | \
            grep -v "$DEFAULT_BRANCH" | \
            sed 's/origin\///' | \
            xargs)

          if [ -z "$MERGED_BRANCHES" ]; then
            echo "No merged branches to delete"
            exit 0
          fi

          echo "Branches to delete:"
          echo "$MERGED_BRANCHES"

          # Delete each merged branch
          for branch in $MERGED_BRANCHES; do
            echo "Deleting branch: $branch"
            gh api \
              --method DELETE \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/${{ github.repository }}/git/refs/heads/$branch" \
              || echo "Failed to delete $branch"
          done

          echo "Branch cleanup complete!"
